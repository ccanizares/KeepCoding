---
title: Docker y .net core
updated: 2017-01-17 15:56
---

En el post anterior entre historias viejunas explicaba un poco la evolución de los desarrolladores de software desde mi perspectiva y la importancia que tiene ser ágil a la hora de levantar entornos y deployar software en estos. 


En este post me propongo hacer una demostración práctica sobre cómo llevar a cabo estas técnicas en entornos enterprise a nivel introductorio con <b>Asp.net Core y Docker</b>. Simularé una aplicación web (asp.net mvc) que consume dos microservicios A y B (asp.net api). 
He escogido estas tecnologías porque me apetece conocer un poco más sobre docker pero DevOps no es sólo docker, podemos hacer devops, IAC (infrastructure as code) y continuous deployment usando un stack totalmente alternativo al que propongo en este ejemplo. He usado un repositorio Git que puedes clonar o descargar si quieres aquí pero no estoy trabajando con ninguna herramienta de ALM que me permita automatizar estas builds desde mi control de código fuente. 


Por tanto el proposito del post es conocer <b>docker</b>, <b>docker-machine</b>, <b>docker-compose</b> y como usarlos en aplicaciones .net core para desplegar a tu entorno de development que será un docker host que tendremos instalado en nuestra máquina local.  

### ¿Qué es docker?

Sin ánimo de ofender a nadie de IT, mi definición de docker para desarrolladores es que es un sistema de virtualización más rápido y ligero que el típico al cual estábamos acostumbrados y que tiene tools y demás que facilitan bastante la creación de la infraestructura donde correrá nuestro software. Por tanto podemos definir la infrastructura donde correrá una aplicación en un fichero que incluimos junto al resto de código de nuestro proyecto, lo que implica que podremos versionarlo, configurar environments, características de las imágenes, escalado, etc.. <b>Docker</b> también está disponible para windows lo cual permite usar este sistema desde un so windows, desplegar todas las máquinas en tu sistema docker local y fácilmente trasladar todos contenedores a un docker remoto (producción o integración…). Esto no quita que en determinados escenarios necesites a gente con conocimientos sólidos de IT para configurar bien clusters, orquestración y escalado bajo demanda… esto ya no es tan sencillo. 
Como comentaba en el ejemplo estoy trabajando con <b>contenedores</b> Linux pero recientemente docker ha añadido soporte para contenedores Windows en su última versión (no lo he probado todavía a día de hoy). 
 
### ¿Qué es Asp.Net Core?

Una de las novedades más esperadas y que empieza a ser una realidad palpable es que .Net es un framework que puede correr también en entornos Linux.
En este ejemplo estoy trabajando con asp.net core 1.0.1 que todavía usa project.json. Intentaré hacer un post en breve trabajando con la versión 1.1 y csproj. Como anticipo, mencionar, que en el connect
de este año pasado (Noviemebre 2016) Microsoft anunció Visual Studio 2017 y pudimos ver en las demos como ha mejorado la integración de Visual Studio con docker... pero eso daría para otro post que espero 
estar motivado para hacer en breve. 

### Microservicios

Mi definición casera es que pasas a tener muchos back-ends cada uno independiente capaz de correr por sí solo. Optar por este tipo de aplicaciones en sustitución de una aplicación monolítica puede ofrecer ventajas, tienes una aplicación modular en la que puedes distribuir un evolutivo parcialmente sin tener que desplegar toda tu aplicación. Otra ventaja es el ahorro de costes a la hora de escalar. Imagina que tienes un portal de venta online, este ofrece un catalogo de productos en la página principal cuyo directorio de productos puede ser consultado 
sin tener que estar registrado en el portal. Se nos da el caso que tenemos un número elevado de peticiones en las páginas libres de registro pero apenas un 2% se registran y completan el proceso de purchase de productos. Seguramente queramos que la experiencia de usuario sea buena al consultar productos, por tanto escalaremos infraestructura si es necesario para que la respuesta y rendimiento del portal sea adecuado... el coste en máquina subirá... si nuestra aplicación es monolítica no podremos decidir si ampliamos máquina para todo el portal o sólo para la parte que recibe más visitas. Otro ejemplo a favor de microservicios, es que puedes desplegar partes de tu aplicación sin necesidad de desplegar todo el paquete completo... Claro, esto añade cierta complejidad al proceso de integración y despliegue de nuestra aplicación de ahí que se diga que los microsservicios surgen un poco de la explosión del fenomeno devops.  

### Aplicación web .net core + servicios paso a paso

A continuación te proporciono los pasos necesarios para desplegar en un tu docker-host local, la idea es tener un contenedor para cada aplicación web.  
En el momento que estoy escribiendo este post está saliendo la RC3 de Visual Studio 2017. Este IDE incorpora tools y "magia" para realizar todo este trabajo que haremos en este post manualmente por ti, pero de momento no queremos "magia" sino entender lo básico de docker y como hacer para correr asp.net core en contenedores. Ya escribiré más adelante sobre como usar docker con Visual Studio 2017 o si no podéis esperar al post siempre podéis ir a este enlace del pasado Connect en channel 9 y ver las demos de Donovan Brown.

#### Ingredientes

Un IDE para trabajar con .net core, te recomiendo VSCode en este ejemplo ya que haremos todo el proceso de deploy manualmente con comandos. 
Si lo haces necesitarás tener yeoman que te proporcionará la template básica de proyecto. 

Asp.net core 1.1

Docker for Windows

#### Overview

La 'arquitectura' está compuesta por 3 aplicaciones web asp.net core, cada una correrá en su propio <b>contenedor docker</b> (instancia independiente). 

#### Estructura de tu .sln (Visual Studio)

```
Restlessminds.Web.sln
|
|___Applications
|		|__Restlessminds.Web
|
|___Services 
|		|__Restlessminds.ServiceA
|		|
|		|__Restlessminds.ServiceB
|
|___Solution Items 
		|__docker-compose.yml
		|__ ...
```


#### Dockerfile, docker hub e imagenes

¿Qué es dockerfile? Es un fichero que contiene la información para construir la imagen. Como decíamos en la sección anterior cada aplicación web correrá en un contenedor diferente, es importante entender que un contenedor se crea a partir de una imagen. 

¿Qué es docker hub? Es un repositorio de imagenes, por defecto docker tiene un hub online oficial donde los fabricantes suben imágenes públicas. Te deberías dar de alta en este servicio para tener acceso a las imagenes de asp.net, si no recuerdo mal durante el proceso de instalación de docker for windows puedes registrarte, si no tendrás que hacerlo por tu cuenta. Tu propio docker-host tiene un repositorio local de imagenes al que necesitaremos añadir una imagen por cada aplicación que posteriormente querré que corra en contenedores. 

¿Como creo las imágenes para mis aplicaciones?

Necesitaremos definir una serie de comandos que se usarán en los scripts ps1 en el proceso de deploy. En estos scripts  usaremos el comando <b>docker build</b> que toma información de este fichero y se encarga de construir las imágenes necesarias. 


Ejemplo de un docker file para una aplicación asp.net: 

```
FROM microsoft/aspnetcore:1.0.1
ENTRYPOINT ["dotnet", "myaspnetcoreapplication.dll"]
ARG source=.
WORKDIR /app
EXPOSE 80
COPY $source .
```

#### Docker-compose.yml


Docker compose es una tool que hemos instalado en el paquete de docker tools for windows y permite definir y lanzar aplicaciones multicontenedor con docker. En el ejemplo que estamos mostrando aquí tenemos un único fichero docker-compose.yml en la root de nuestra solución pero podríamos tener uno por entorno si fuese el caso. 


Ejemplo docker-compose-yml: 


```
version: '2'

services:
  web:
    image: restless/web
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - serviceAUrl=http://serviceA.api
      - serviceBUrl=http://serviceB.api
    ports:
      - "5000:80"
    depends_on:
      - serviceA.api
      - serviceB.api

  serviceA.api:
    image: restlessminds_web/serviceA.api
    expose:
      - "80"
    ports:
      - "5001:80"

  serviceB.api:
    image: restlessminds_web/serviceB.api
    expose:
      - "80"
    ports:
      - "5002:80"
```


#### build script
``` powerShell
$scriptPath = Split-Path $script:MyInvocation.MyCommand.Path
$pubFolder = $scriptPath + "\pub"
$webJson = $scriptPath + "\src\applications\restlessminds.web\project.json"
$serviceAJson = $scriptPath + "\src\services\restlessminds.serviceA\project.json"
$serviceBJson = $scriptPath + "\src\services\restlessminds.serviceB\project.json"

$webPub = $scriptPath + "\pub\web"
$serviceAPub = $scriptPath + "\pub\serviceA"
$serviceBPub = $scriptPath + "\pub\serviceB"

dotnet restore $webJson
dotnet build $webJson
dotnet publish $webJson -o $webPub

dotnet restore $serviceAJson
dotnet build $serviceAJson
dotnet publish $serviceAJson -o $serviceAPub

dotnet restore $serviceBJson
dotnet build $serviceBJson
dotnet publish $serviceBJson -o $serviceBPub

docker build -t restlessminds/web $webPub
docker build -t restlessminds/serviceA $serviceAPub
docker build -t restlessminds/serviceB $serviceBPub
```

#### deploy script
```
docker stop $(docker ps -qa)
docker rm $(docker ps -qa)
docker-compose up
```

Ojo, este script elimina los <b>contenedores</b> que hay en el host local. Si tienes otras aplicaciones que usan tu docker host local como host de virtualización elimina las líneas stop y rm del script.

### Ready? Go! Despliegue a docker host. 


Una vez hemos vertido los ingredientes y hemos realizado todos los preparativos esto debería funcionar. Para desplegar nuestra aplicación tendremos que ejecutar el script de build y una vez termine ejecutaremos el de deploy. 


Imagen de la web funcionando. 


### Comandos útiles docker


### Tools útiles docker


Y hasta aquí el post de hoy. En el siguiente post de esta serie me crearé un docker host en Azure y mostraré cómo desplegar a este host remoto que podría simular un entorno de pre, staging o integración. 


Remarcar que el objetivo de este post es conocer un poco como puede ayudarnos docker a los desarrolladores… En esta serie de correos estoy hablando de <b>devops</b> y de diferentes conceptos y herramientas, aprovechando que hemos hablado de docker en este post os recomiendo leer este post que me gustó bastante, bastante práctico si eres dev y tocas muchos palos para no tener que formatear tu pc cada 2 meses. 
















#### Estructura física en carpetas


Esta es mi propuesta sobre cómo debería quedar el directorio para trabajar con docker, no es estándar puedes montartelo diferente mientras entiendas los puntos clave para dockerizar los servicios y web. Los ficheros dockerfile, dockercompose.yaml y los ps1 los puedes ir creando y dejarlos vacíos o crearlos más tarde como prefieras. 

```
Restlessminds.Web
|
|__  src
|      |___Services
|      |           |____Restlessminds.ServiceA
|      |           |                       |__dockerfile
|      |	   |
|      |	   |____Restlessminds.ServiceB
|      |	                           |__dockerfile	
|      |	   	
|      |
|      |___Applications
|		   |____restlessminds.web
|			              |__dockerfile
|
|__  pub
|      |___serviceB
|      |___serviceA
|      |___web	      
|
|__ dockercompose.yml
|__ build.ps1
|__ deploydev.ps1
```


